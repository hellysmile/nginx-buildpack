#!/usr/bin/env bash

set -eo pipefail

BUILD_DIR=$1
CACHE_DIR=$2

mkdir -p "$BUILD_DIR/bin/"

./bin/compile_nginx "$BUILD_DIR/bin/"

nginx_version=$(./bin/nginx -V 2>&1 | head -1 | awk '{ print $NF }')
echo "-----> nginx-buildpack: Installed ${nginx_version} to app/bin"

cp ./bin/start-nginx "$BUILD_DIR/bin/"
echo '-----> nginx-buildpack: Added start-nginx to app/bin'

mkdir -p "$BUILD_DIR/logs/nginx"
echo '-----> nginx-buildpack: Create logs directiry at app/logs/nginx'

mkdir -p "$BUILD_DIR/nginx_config"
echo '-----> nginx-buildpack: Create nginx_config directiry at app/nginx_config'

cp ./nginx_config/mime.types "$BUILD_DIR/nginx_config/"
echo '-----> nginx-buildpack: Default mime.types copied to app/nginx_config'

cp ./nginx_config/uwsgi_params "$BUILD_DIR/nginx_config/"
echo '-----> nginx-buildpack: Default uwsgi_params copied to app/nginx_config'

exit 0
