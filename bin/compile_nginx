#!/bin/bash

NGINX_VERSION=1.4.4
PCRE_VERSION=8.34

nginx_tarball_url="http://nginx.org/download/nginx-${NGINX_VERSION}.tar.gz"
pcre_tarball_url="http://garr.dl.sourceforge.net/project/pcre/pcre/${PCRE_VERSION}/pcre-${PCRE_VERSION}.tar.bz2"

nginx_build_dir=$(mktemp -d /tmp/nginx_build.XXXXXXXXXX)
nginx_release_dir=$(mktemp -d /tmp/nginx_release.XXXXXXXXXX)

configure="--with-pcre=pcre-${PCRE_VERSION} --prefix=$nginx_release_dir"

BUILD_DIR=$1

cleanup() {
  echo "Cleaning up $nginx_build_dir"
  echo "Cleaning up $nginx_release_dir"
  rm -rf "$nginx_build_dir"
  rm -rf "$nginx_release_dir"
}

trap cleanup EXIT

cd $nginx_build_dir
echo "Temp dir: nginx_build_dir"

echo "Downloading and extracting $nginx_tarball_url"
curl $nginx_tarball_url | tar xfvz -

echo "Changing directory to nginx-${NGINX_VERSION}"
cd nginx-${NGINX_VERSION}

echo "Downloading and extracting  $pcre_tarball_url"
curl $pcre_tarball_url | tar xfvj -

echo "Configuring nginx"
./configure "$configure"

echo "Compiling nginx"
make

echo "Installing nginx"
make install

echo "Extracting the nginx binary into the buildback"
cp "$nginx_release_dir/sbin/nginx" "$BUILD_DIR/bin/"
